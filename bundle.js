(()=>{"use strict";window.util={getRandomInt:e=>Math.floor(Math.random()*Math.floor(e)),getRandomIntInclusive:(e,t)=>{const n=Math.ceil(e),o=Math.floor(t);return Math.floor(Math.random()*(o-n+1))+n},getRandomDescription:e=>{let t=e.slice(),n=[];for(let o=0,i=window.util.getRandomInt(e.length);o<i;o++)n.push(t.splice(window.util.getRandomInt(t.length),1)[0]);return n},debounce:function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}}},(()=>{const e=document.querySelector(".map"),t=e.clientWidth,n=document.querySelector("main"),o=e.querySelector(".map__pin--main"),i=o.clientWidth,a=o.clientHeight,r={x:o.offsetLeft,y:o.offsetTop};window.constants={MAX_PINS_ON_MAP:5,POINTER_HEIGHT:16,OFFSET_X:25,OFFSET_Y:70,LOC_X_MIN:0,LOC_X_MAX:t,LOC_Y_MIN:130,LOC_Y_MAX:630,MAP:e,ESC_KEY:"Escape",MOUSE_MAIN_BUTTON:0,HABITATION_TYPE:{palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},pageMain:n,mainPinWidth:i,mainPinHeight:a,mainPin:o,mainPinStartPosition:r}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",n="GET",o="POST";window.server={loadedOffers:void 0,load:(t,o)=>{const i=new XMLHttpRequest;i.responseType="json",i.timeout=1e4,i.open(n,e),i.addEventListener("load",(function(){200===i.status?(t(i.response),window.server.loadedOffers=i.response):o(`Статус ответа: ${i.status} ${i.statusText}`)})),i.addEventListener("error",(function(){o("Внутренняя ошибка сервера")})),i.addEventListener("timeout",(function(){o(`Время запроса ${i.timeout}мс вышло. Запрос не успел выполниться`)})),i.send()},upload:(e,n,i)=>{const a=new XMLHttpRequest;a.responseType="json",a.addEventListener("load",(function(){n(a.response)})),a.addEventListener("error",(function(){i()})),a.addEventListener("timeout",(function(){i()})),a.open(o,t),a.send(e)}}})(),(()=>{const e=document.querySelector("#card"),t=()=>{const e=window.constants.MAP.querySelector(".map__card"),o=window.constants.MAP.querySelector(".map__pin--active");if(e){const n=e.querySelector(".popup__close");e.remove(),n.removeEventListener("click",t)}o&&o.classList.remove("map__pin--active"),document.removeEventListener("keydown",n)},n=e=>{e.key===window.constants.ESC_KEY&&(e.preventDefault(),t(e))};window.card={renderCard:t=>{const n=e.content.cloneNode(!0),o=n.querySelector(".popup__avatar"),i=n.querySelector(".popup__title"),a=n.querySelector(".popup__text--address"),r=n.querySelector(".popup__text--price"),s=n.querySelector(".popup__type"),d=n.querySelector(".popup__text--capacity"),c=n.querySelector(".popup__text--time"),l=n.querySelector(".popup__description"),w=n.querySelector(".popup__features"),u=n.querySelector(".popup__photos");o.src=t.author.avatar,i.textContent=t.offer.title,a.textContent=t.offer.address,r.innerHTML=t.offer.price+"&#x20bd;<span>/ночь</span>",s.textContent=window.constants.HABITATION_TYPE[t.offer.type],d.textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`,c.textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,l.textContent=t.offer.description,w.innerHTML="",u.innerHTML="";const p=document.createDocumentFragment(),f=document.createDocumentFragment();for(let e=0;e<t.offer.features.length;e++){let n=document.createElement("li");n.classList.add("popup__feature","popup__feature--"+t.offer.features[e]),p.appendChild(n)}for(let e=0;e<t.offer.photos.length;e++){let n=document.createElement("img");n.classList.add("popup__photo"),n.width=45,n.height=40,n.alt="Фотография жилья",n.src=t.offer.photos[e],f.appendChild(n)}return w.appendChild(p),u.appendChild(f),n},openCard:e=>{window.constants.MAP.querySelector(".map__card")&&t(),e.querySelector(".popup__close").addEventListener("click",t),document.addEventListener("keydown",n),window.constants.MAP.insertBefore(e,window.constants.MAP.querySelector(".map__filters-container"))},closeCard:t,closeCardByEsc:n}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin"),n=document.querySelector("#address"),o=0,i=window.constants.MAP.clientWidth,a=130,r=630,s=e=>{const t=window.constants.mainPin.offsetLeft,o=window.constants.mainPin.offsetTop,i=window.constants.mainPin.clientHeight,a=window.constants.mainPin.clientWidth,r=Math.floor(t+a/2),s=e?Math.floor(o+i+window.constants.POINTER_HEIGHT):Math.floor(o+i/2);n.value=`${r}, ${s}`};window.pin={MAP_PINS:e,loadedOffers:[],renderPin:(e,n)=>{const o=t.content.cloneNode(!0),i=o.querySelector(".map__pin"),a=o.querySelector("img");return i.style=`left: ${e.location.x-window.constants.OFFSET_X}px; top: ${e.location.y-window.constants.OFFSET_Y}px`,a.src=e.author.avatar,a.alt=e.offer.title,i.dataset.id=n,o},removePins:()=>{window.constants.MAP.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((function(e){e.remove()}))},pinClickHandler:e=>{const t=window.constants.MAP.querySelector(".map__pin--active");e.target.classList.contains("map__pin")&&!e.target.classList.contains("map__pin--main")?(t&&t.classList.remove("map__pin--active"),window.card.closeCard(e),window.card.openCard(window.card.renderCard(window.pin.loadedOffers[e.target.dataset.id])),e.target.classList.add("map__pin--active")):e.target.parentElement.classList.contains("map__pin")&&!e.target.parentElement.classList.contains("map__pin--main")&&(t&&t.classList.remove("map__pin--active"),window.card.closeCard(e),window.card.openCard(window.card.renderCard(window.pin.loadedOffers[e.target.parentElement.dataset.id])),e.target.parentElement.classList.add("map__pin--active"))},setCoordinates:s,movePin:e=>{if(e.button===window.constants.MOUSE_MAIN_BUTTON){let t={x:e.clientX,y:e.clientY};const n=e=>{e.preventDefault();let n=t.x-e.clientX,d=t.y-e.clientY;window.constants.mainPin.style.left=window.constants.mainPin.offsetLeft-n+"px",window.constants.mainPin.style.top=window.constants.mainPin.offsetTop-d+"px",t={x:e.clientX,y:e.clientY},window.constants.mainPin.offsetLeft<=o-window.constants.mainPin.offsetWidth/2?window.constants.mainPin.style.left=o-window.constants.mainPin.offsetWidth/2+"px":window.constants.mainPin.offsetLeft>=i-window.constants.mainPin.offsetWidth/2&&(window.constants.mainPin.style.left=i-window.constants.mainPin.offsetWidth/2+"px"),window.constants.mainPin.offsetTop<a-window.constants.mainPin.offsetHeight-window.constants.POINTER_HEIGHT?window.constants.mainPin.style.top=a-window.constants.mainPin.offsetHeight-window.constants.POINTER_HEIGHT+"px":window.constants.mainPin.offsetTop>r-window.constants.mainPin.offsetHeight-window.constants.POINTER_HEIGHT&&(window.constants.mainPin.style.top=r-window.constants.mainPin.offsetHeight-window.constants.POINTER_HEIGHT+"px"),s(!0)},d=e=>{e.preventDefault(),s(!0),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",d)}}}})(),window.map={fillElement:e=>{window.pin.MAP_PINS.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((function(e){e.remove()}));const t=window.constants.MAX_PINS_ON_MAP<e.length?window.constants.MAX_PINS_ON_MAP:e.length,n=document.createDocumentFragment();window.pin.loadedOffers=e;for(let o=0;o<t;o++)e[o].offer&&n.appendChild(window.pin.renderPin(e[o],o));window.pin.MAP_PINS.appendChild(n)}},(()=>{const e=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: #f0f0ea; vertical-align: middle",t.style.position="absolute",t.style.width="80%",t.style.left=0,t.style.right=0,t.style.top="30px",t.style.fontSize="30px",t.textContent=e+".\n    Укажите местоположение вашего объявления без соседних",document.body.insertAdjacentElement("afterbegin",t)},t=e=>{for(let e of window.form.filterFormElements)e.disabled=!1;window.map.fillElement(e)},n=o=>{o.button===window.constants.MOUSE_MAIN_BUTTON&&(window.server.load(t,e),(()=>{window.form.adForm.classList.remove("ad-form--disabled"),window.pin.setCoordinates(!0);for(let e of window.form.adFormElements)e.disabled=!1})(),window.constants.MAP.classList.remove("map--faded"),window.constants.mainPin.removeEventListener("mousedown",n))};window.page={activatePage:n,disactivatePage:()=>{window.constants.MAP.classList.add("map--faded"),window.form.adForm.classList.add("ad-form--disabled");for(let e of window.form.adFormElements)e.disabled=!0;for(let e of window.form.filterFormElements)e.disabled=!0;window.constants.mainPin.style.left=window.constants.mainPinStartPosition.x+"px",window.constants.mainPin.style.top=window.constants.mainPinStartPosition.y+"px",window.card.closeCard(),window.pin.setCoordinates(!1),window.pin.removePins(),window.constants.mainPin.addEventListener("mousedown",n)}}})(),(()=>{const e="box-shadow: 0 0 5px 5px rgba(255, 55, 55, 0.5);",t="box-shadow: 0;",n={1:"Только на одного гостя",2:"Только на одного или двух гостей",3:"Только на одного, двух или трех гостей",100:"Только не для гостей"},o={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},i={bungalow:0,flat:1e3,house:5e3,palace:1e4};window.formValidation={errorNotice:e,nonNotice:t,guestValidation:n,guestCapacity:o,priceOfType:i,typeOfRoom:"1",typeOfHouse:"flat",typeOfCapacity:i=>{const a=i.value;o[window.formValidation.typeOfRoom].some((function(e){return e===a}))?(i.style=t,i.setCustomValidity("")):(i.style=e,i.setCustomValidity(n[window.formValidation.typeOfRoom])),i.reportValidity()},priceValidation:function(e){const t=e.value;e.validity.valueMissing?e.setCustomValidity("Обязательное поле"):t<i[window.formValidation.typeOfHouse]?e.setCustomValidity("Минимальная цена "+i[window.formValidation.typeOfHouse]):t>1e6?e.setCustomValidity("Максимальная цена 1000000"):e.setCustomValidity(""),e.reportValidity()},valueLengthValidation:(e,t,n)=>{let o=e.value.length;o<t?e.setCustomValidity(`Ещё хотя бы ${t-o} знака(ов)`):o>n?e.setCustomValidity(`Слишком длинно. Удалите лишние ${o-n} знака(ов)`):e.setCustomValidity(""),e.reportValidity()}}})(),(()=>{const e=window.constants.MAP.querySelector(".map__filters"),t=e.children,n=document.querySelector(".ad-form"),o=n.children,i=n.querySelector("#address"),a=n.querySelector("#room_number"),r=n.querySelector("#capacity"),s=n.querySelector(".ad-form__reset"),d=n.querySelector(".ad-form__submit"),c=n.querySelectorAll("input"),l=n.querySelector("#title"),w=n.querySelector("#type"),u=n.querySelector("#price"),p=n.querySelector("#timein"),f=n.querySelector("#timeout"),m=n.querySelector("#avatar"),y=n.querySelector("#images"),_=document.querySelector("#success"),v=document.querySelector("#error"),E=e=>{e.preventDefault();const t=window.constants.pageMain.querySelector(".success");window.constants.pageMain.removeChild(t),document.removeEventListener("click",E),document.removeEventListener("keydown",g)},g=e=>{e.key===window.constants.ESC_KEY&&E(e)},h=e=>{e.preventDefault();const t=window.constants.pageMain.querySelector(".error"),n=t.querySelector(".error__button");window.constants.pageMain.removeChild(t),document.removeEventListener("click",h),document.removeEventListener("keydown",P),n.removeEventListener("click",h)},P=e=>{e.key===window.constants.ESC_KEY&&h(e)},S=e=>{e===p?f.value=p.value:p.value=f.value};n.action="https://21.javascript.pages.academy/keksobooking",i.readOnly=!0,window.pin.setCoordinates(!1),a.addEventListener("change",(function(e){window.formValidation.typeOfRoom=e.target.value,window.formValidation.typeOfCapacity(r)})),r.addEventListener("change",(function(e){window.formValidation.typeOfCapacity(e.target)})),s.addEventListener("click",(function(){n.reset(),e.reset(),window.page.disactivatePage()})),l.required=!0,l.minLength=30,l.maxLength=100,l.addEventListener("input",(function(e){window.formValidation.valueLengthValidation(e.target,30,100)})),u.required=!0,u.max=1e6,u.placeholder=window.formValidation.priceOfType[window.formValidation.typeOfHouse],u.addEventListener("input",(function(e){window.formValidation.priceValidation(e.target)})),w.addEventListener("change",(function(){window.formValidation.typeOfHouse=w.value,u.placeholder=window.formValidation.priceOfType[window.formValidation.typeOfHouse],u.min=window.formValidation.priceOfType[window.formValidation.typeOfHouse],window.formValidation.priceValidation(u)})),m.accept="image/*",y.accept="image/*",p.addEventListener("change",(function(e){S(e.target)})),f.addEventListener("change",(function(e){S(e.target)})),d.addEventListener("click",(function(){c.forEach((function(e){e.validity.valid?e.style=window.formValidation.nonNotice:e.style=window.formValidation.errorNotice}))})),n.addEventListener("submit",(function(t){window.server.upload(new FormData(n),(function(){e.reset(),n.reset(),window.page.disactivatePage(),(()=>{const e=_.content.cloneNode(!0);document.addEventListener("click",E),document.addEventListener("keydown",g),window.constants.pageMain.appendChild(e)})()}),(function(){(()=>{const e=v.content.cloneNode(!0),t=e.querySelector(".error__button");document.addEventListener("click",h),document.addEventListener("keydown",P),t.addEventListener("click",h),window.constants.pageMain.appendChild(e)})()})),t.preventDefault()})),window.form={filterForm:e,filterFormElements:t,adForm:n,adFormElements:o,addressInput:i,syncInOutTime:S}})(),(()=>{const e="any",t={TYPE:window.form.filterForm.querySelector("#housing-type"),PRICE:window.form.filterForm.querySelector("#housing-price"),ROOMS:window.form.filterForm.querySelector("#housing-rooms"),GUESTS:window.form.filterForm.querySelector("#housing-guests"),FEATURES:window.form.filterForm.querySelector("#housing-features")},n=e=>Array.from(t.FEATURES.querySelectorAll(".map__checkbox:checked")).every((function(t){return e.offer.features.some((function(e){return t.value===e}))}));window.form.filterForm.addEventListener("change",window.util.debounce((function(o){window.card.closeCard(o),window.map.fillElement((o=>{let i=(n=>t.TYPE.value===e?n:n.filter((function(e){return e.offer.type===t.TYPE.value})))(o);return i=(n=>{let o=n;switch(t.PRICE.value){case e:break;case"low":o=o.filter((function(e){return e.offer.price<=9999}));break;case"middle":o=o.filter((function(e){return e.offer.price>9999&&e.offer.price<=5e4}));break;case"high":o=o.filter((function(e){return e.offer.price>5e4}))}return o})(i),i=(n=>t.ROOMS.value===e?n:n.filter((function(e){return e.offer.rooms===parseInt(t.ROOMS.value,10)})))(i),i=(n=>t.GUESTS.value===e?n:n.filter((function(e){return e.offer.guests===parseInt(t.GUESTS.value,10)})))(i),i=(e=>e.filter(n))(i),i})(window.server.loadedOffers))})))})(),window.page.disactivatePage(),window.constants.mainPin.addEventListener("mousedown",window.pin.movePin),window.pin.MAP_PINS.addEventListener("click",(function(e){e.preventDefault(),window.pin.pinClickHandler(e)}))})();